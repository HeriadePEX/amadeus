# Amadeus REST API (local wrapper)

This project exposes simple REST endpoints that forward requests to Amadeus SOAP services.
The REST layer is intentionally NOT secured yet. SOAP security headers are generated by the
backend according to "SOAP Header 4.0 Implementation Guide (2) (3).pdf".

## Why there is no GET

All SOAP calls require a complex XML payload, so the REST endpoints accept JSON bodies.
HTTP GET is not used because it does not support a request body in a reliable way.

## Base

- Base path: `/api`
- Content-Type: `application/json`
- Each request body has:
  - `payload`: the SOAP request object (JAXB)
  - `session` (optional): the Amadeus session context

Common request shape:

```json
{
  "payload": { },
  "session": {
    "sessionId": "string",
    "sequenceNumber": 1,
    "securityToken": "string",
    "transactionStatusCode": "string"
  }
}
```

Common response shape:

```json
{
  "payload": { },
  "session": {
    "sessionId": "string",
    "sequenceNumber": 2,
    "securityToken": "string",
    "transactionStatusCode": "string"
  }
}
```

## Endpoints

1) Create Profile

- `POST /api/profiles`
- SOAP action: `Profile_CreateProfile_12.2`
- Payload type: `AMAProfileCreateRQ`
- Response: `AMAProfileCreateRS`

Example:

```bash
curl -X POST "http://localhost:8080/api/profiles" \
  -H "Content-Type: application/json" \
  -d '{
    "payload": {
      "Version": 12.2,
      "Profile": {
        "ProfileType": "C"
      }
    }
  }'
```

Example (Company profile, from doc):

```bash
curl -X POST "http://localhost:8080/api/profiles" \
  -H "Content-Type: application/json" \
  -d '{
    "payload": {
      "version": 12.2,
      "uniqueID": [
        {
          "type": "9",
          "ID": "ABC6F0020",
          "IDContext": "CSX"
        }
      ],
      "profile": {
        "profileType": "3",
        "status": "A",
        "prefCollections": {
          "prefCollection": [
            {
              "airlinePref": {
                "airportOriginPref": {
                  "locationCode": "SYD"
                }
              }
            }
          ]
        },
        "companyInfo": {
          "companyName": {
            "value": "TEST COMPANY NAME"
          },
          "addressInfo": [
            {
              "formattedInd": true,
              "defaultInd": true,
              "useType": "2",
              "addressLine": [
                "55 STREET"
              ],
              "cityName": "London",
              "countryName": {
                "code": "GB"
              },
              "addresseeName": {
                "surname": "CLAIRE"
              }
            }
          ],
          "telephoneInfo": [
            {
              "phoneLocationType": "6",
              "phoneTechType": "1",
              "phoneNumber": "NCE12345678"
            }
          ]
        }
      }
    }
  }'
```

2) Read Profile (search)

- `POST /api/profiles/search`
- SOAP action: `Profile_ReadProfile_12.2`
- Payload type: `AMAProfileReadRQ`
- Response: `AMAProfileReadRS`

Example:

```bash
curl -X POST "http://localhost:8080/api/profiles/search" \
  -H "Content-Type: application/json" \
  -d '{
    "payload": {
      "Version": 12.2,
      "ReadRequests": {
        "ProfileReadRequest": {
          "UniqueID": {
            "Type": "C",
            "ID": "ABC123"
          }
        }
      }
    }
  }'
```

Example (with office scope required by some PCCs):

```bash
curl -X POST "http://localhost:8080/api/profiles/search" \
  -H "Content-Type: application/json" \
  -d '{
    "payload": {
      "version": 12.2,
      "uniqueID": [
        {
          "type": "9",
          "ID": "PARFT2796",
          "IDContext": "CSX"
        }
      ],
      "readRequests": {
        "profileReadRequest": {
          "profileType": "1",
          "uniqueID": {
            "type": "21",
            "ID": "19SYY8",
            "IDContext": "CSX",
            "instance": "1"
          }
        }
      }
    }
  }'
```

3) Update Profile

- `PUT /api/profiles`
- SOAP action: `Profile_UpdateProfile_12.2`
- Payload type: `AMAUpdateRQ`
- Response: `AMAUpdateRS`

Example:

```bash
curl -X PUT "http://localhost:8080/api/profiles" \
  -H "Content-Type: application/json" \
  -d '{
    "payload": {
      "Version": 12.2,
      "Position": {
        "XPath": "/Profile",
        "Root": {
          "Operation": "replace",
          "UniqueID": [
            { "Type": "C", "ID": "ABC123" }
          ],
          "Profile": {
            "ProfileType": "C"
          }
        }
      }
    }
  }'
```

4) Delete Profile

- `DELETE /api/profiles`
- SOAP action: `Profile_DeleteProfile_12.2`
- Payload type: `AMADeleteRQ`
- Response: `AMADeleteRS`

Example:

```bash
curl -X DELETE "http://localhost:8080/api/profiles" \
  -H "Content-Type: application/json" \
  -d '{
    "payload": {
      "Version": 12.2,
      "UniqueID": [
        { "Type": "C", "ID": "ABC123" }
      ],
      "DeleteRequests": {
        "ProfileDeleteRequest": {
          "ProfileType": "C"
        }
      }
    }
  }'
```

5) List Deactivated Profiles

- `POST /api/profiles/deactivated`
- SOAP action: `Profile_ListDeactivatedProfiles_1.1` (FUDREQ_01_1_1A)
- Payload type: `ProfileListDeactivatedProfiles`
- Response: `ProfileListDeactivatedProfilesReply`

Example:

```bash
curl -X POST "http://localhost:8080/api/profiles/deactivated" \
  -H "Content-Type: application/json" \
  -d '{
    "payload": {
      "messageActionDetails": {
        "messageDetails": {
          "function": "L",
          "codeListResponsibleAgency": "1A"
        }
      },
      "retrieveProfileDomain": {
        "profileOwner": {
          "officeID": "PAR1A1234"
        },
        "retrieveDomain": {
          "corporateIdentification": "ABC"
        },
        "followUpDisplayDate": "20250101",
        "deactivatedDate": "20240101"
      },
      "inputIndicator": {
        "numberOfLinesToBeReturned": 10
      }
    }
  }'
```

6) Sign Out (end session)

- `DELETE /api/sessions`
- SOAP action: `Security_SignOut_4.1` (VLSSOQ_04_1_1A)
- Payload type: `SecuritySignOut`
- Response: `SecuritySignOutReply`

Example:

```bash
curl -X DELETE "http://localhost:8080/api/sessions" \
  -H "Content-Type: application/json" \
  -d '{
    "payload": {
      "conversationClt": {
        "senderIdentification": "SENDER1",
        "recipientIdentification": "RECIP1",
        "senderInterchangeControlReference": "CTRLREF1",
        "recipientInterchangeControlReference": "CTRLREF2"
      }
    }
  }'
```

## SOAP security (backend-generated)

The REST caller does not provide security headers. The backend builds them automatically:

- WS-Addressing: `MessageID`, `Action`, `To`
- WS-Security: `UsernameToken` with `Username`, `Nonce`, `PasswordDigest`, `Created`
- Amadeus Security: `AMA_SecurityHostedUser` with `UserID` attributes
- Session header (when `session` is provided)

Implementation location:

- `src/main/java/com/kalixys/amadeus/api/soap/SoapHeaderBuilder.java`

## Errors

- 400 `invalid_request`: `payload` is missing
- 400 `soap_mapping_error`: JAXB mapping error
- 502 `soap_fault`: SOAP fault from Amadeus
- 502 `soap_transport_error`: transport/connection error
